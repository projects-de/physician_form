<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Still Waters - Schedule Physician Appointment</title>
  <style>
    /* --- Reset & Tokens --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root{
      /* Palette */
      --primary: #4f46e5;
      --primary-700:#4338ca;
      --secondary:#06b6d4;
      --accent: #38bdf8;
      --success: #10b981;
      --danger: #ef4444;

      /* Neutrals */
      --bg: #f6f7fb;
      --card: #ffffff;
      --muted: #6b7280;
      --text: #0f172a;
      --text-soft:#334155;
      --border: #e5e7eb;

      /* Elevation */
      --shadow: 0 8px 24px rgba(2, 6, 23, .08);
      --shadow-lg: 0 18px 40px rgba(2, 6, 23, .12);

      /* Focus ring */
      --ring: rgba(79, 70, 229, .45);
      --ring-strong: rgba(6, 182, 212, .45);

      /* Radii */
      --r-lg: 20px;
      --r-xl: 24px;
      --r-full: 9999px;

      /* Transitions */
      --t-fast: .15s ease;
      --t-med: .25s ease;

      /* Slot sizing */
      --chip-min: 120px;
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg: #0b1220;
        --card: #0f172a;
        --text: #e5e7eb;
        --text-soft:#cbd5e1;
        --border: #1f2937;
        --shadow: 0 8px 24px rgba(0,0,0,.5);
        --shadow-lg: 0 18px 50px rgba(0,0,0,.55);
        --ring: rgba(56, 189, 248, .5);
        --ring-strong: rgba(99, 102, 241, .55);
      }
    }

    /* --- Page --- */
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      padding: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(79,70,229,.14), transparent 60%),
        radial-gradient(800px 500px at 90% 10%, rgba(6,182,212,.16), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg));
    }

    .container{
      width: 100%;
      max-width: 800px;
      background: linear-gradient(0deg, rgba(255,255,255,.6), rgba(255,255,255,.6)), var(--card);
      backdrop-filter: saturate(120%) blur(6px);
      border: 1px solid var(--border);
      border-radius: var(--r-xl);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      animation: slideIn .4s ease-out both;
    }

    @keyframes slideIn{ from{ opacity:0; transform: translateY(18px);} to{ opacity:1; transform: translateY(0);} }

    /* --- Header --- */
    .header{
      padding: 40px 32px;
      color: #fff;
      background:
        radial-gradient(800px 200px at 20% -20%, rgba(56,189,248,.35), transparent 60%),
        linear-gradient(135deg, var(--primary), var(--secondary));
    }
    .header h1{
      font-size: clamp(1.8rem, 2.6vw, 2.6rem);
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 8px;
    }
    .header p{
      font-size: 1.05rem;
      opacity: .95;
    }

    /* --- Form layout --- */
    .form-container{ padding: 32px; }
    .form-section{ margin-bottom: 28px; animation: fadeIn .35s ease-out both; }
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }

    .form-section h2{
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 16px;
    }

    .form-group{ margin-bottom: 16px; }
    .form-row{ display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }

    label{
      display: block;
      color: var(--text-soft);
      font-weight: 600;
      margin-bottom: 8px;
      font-size: .95rem;
    }
    .required{ color: var(--danger); }

    /* --- Inputs --- */
    input[type="text"],
    input[type="tel"],
    select{
      width: 100%;
      appearance: none;
      background: var(--card);
      color: var(--text);
      border: 1.5px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 1rem;
      transition: border-color var(--t-fast), box-shadow var(--t-fast), background var(--t-fast), transform var(--t-fast);
    }

    input:hover, select:hover{
      border-color: color-mix(in oklab, var(--primary) 25%, var(--border));
    }
    input:focus, select:focus{
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--ring);
    }

    /* --- Choice groups --- */
    .radio-group{ display:flex; gap:14px; flex-wrap:wrap; margin-top: 8px; }
    .radio-option{
      display:flex; align-items:center; gap:10px;
      background: var(--card);
      border: 1.5px solid var(--border);
      border-radius: 12px;
      padding: 12px 16px;
      cursor: pointer;
      transition: transform var(--t-fast), box-shadow var(--t-fast), border-color var(--t-fast), background var(--t-fast);
      user-select: none;
    }
    .radio-option:hover{ transform: translateY(-1px); border-color: var(--primary); box-shadow: var(--shadow); }
    .radio-option.selected{
      border-color: var(--primary);
      background: linear-gradient(0deg, rgba(79,70,229,.06), rgba(6,182,212,.06));
      box-shadow: inset 0 0 0 1.5px color-mix(in oklab, var(--primary) 60%, transparent);
    }
    .radio-option input[type="radio"]{ width: 18px; height: 18px; }

    /* --- Slots --- */
    .time-slots{ display: grid; grid-template-columns: 1fr; gap: 16px; margin-top: 14px; }
    .time-slot{
      background: var(--card);
      border: 1.5px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .time-slot .date{ font-weight: 800; font-size: 1rem; color: var(--text); margin-bottom: 6px; }
    .time-slot .range{ color: var(--muted); font-size: .95rem; margin-bottom: 12px; }

    .slot-grid{ display: grid; grid-template-columns: repeat(auto-fill, minmax(var(--chip-min), 1fr)); gap: 10px; }
    .slot-chip{
      padding: 10px 12px;
      text-align: center;
      border-radius: var(--r-full);
      background: linear-gradient(180deg, #ffffff, #fafafa);
      color: var(--text);
      border: 1.5px solid var(--border);
      font-weight: 600;
      font-size: .95rem;
      cursor: pointer;
      transition: transform var(--t-fast), box-shadow var(--t-fast), border-color var(--t-fast), background var(--t-fast), color var(--t-fast);
    }
    .slot-chip:hover{ transform: translateY(-1px); border-color: var(--primary); box-shadow: var(--shadow); }
    .slot-chip:focus-visible{ outline: 0; box-shadow: 0 0 0 4px var(--ring-strong); }
    .slot-chip.selected{
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #fff;
      border-color: transparent;
      box-shadow: 0 8px 26px rgba(79,70,229,.35);
    }

    .hidden{ display:none !important; }

    /* --- Buttons --- */
    .button-group{ display:flex; gap: 12px; justify-content:center; margin-top: 28px; flex-wrap: wrap; }
    .btn{
      border: 0; border-radius: 12px;
      padding: 14px 28px;
      font-size: 1.05rem; font-weight: 800; letter-spacing: .02em;
      cursor: pointer;
      transition: transform var(--t-med), box-shadow var(--t-med), opacity var(--t-fast);
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .btn-primary{
      color:#fff;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      box-shadow: 0 10px 28px rgba(79,70,229,.35);
    }
    .btn-primary:hover:not(:disabled){ transform: translateY(-2px); box-shadow: 0 16px 40px rgba(79,70,229,.45); }

    .btn-secondary{
      color: var(--primary);
      background: linear-gradient(180deg, #ffffff, #fafafa);
      border: 1.5px solid color-mix(in oklab, var(--primary) 22%, var(--border));
    }
    .btn-secondary:hover{ transform: translateY(-2px); box-shadow: var(--shadow); }

    /* --- Alerts --- */
    .success-message,
    .error-message{
      display:none;
      border-radius: 12px;
      padding: 14px 16px;
      font-weight: 700;
      margin: 14px 0;
      box-shadow: var(--shadow);
      animation: slideDown .35s ease-out both;
    }
    @keyframes slideDown{ from{opacity:0; transform: translateY(-6px)} to{opacity:1; transform: translateY(0)} }

    .success-message{ background: color-mix(in oklab, var(--success) 18%, #ecfdf5); color: #065f46; border: 1.5px solid color-mix(in oklab, var(--success) 40%, #ffffff); }
    .error-message{ background: color-mix(in oklab, var(--danger) 18%, #fef2f2); color: #7f1d1d; border: 1.5px solid color-mix(in oklab, var(--danger) 40%, #ffffff); }

    /* --- Confirmation card --- */
    .confirm-card{
      display:none;
      background: color-mix(in oklab, var(--success) 10%, #fff);
      border: 1.5px solid color-mix(in oklab, var(--success) 30%, #fff);
      border-radius: 16px;
      padding: 18px;
      box-shadow: var(--shadow);
      margin: 16px 0;
    }
    .confirm-card.visible{ display:block; }
    .confirm-card h3{ font-size:1.15rem; font-weight:800; margin-bottom:8px; color:#065f46; }
    .confirm-row{ display:flex; gap:10px; align-items:flex-start; margin:6px 0; color:#064e3b; }
    .confirm-row b{ min-width:130px; display:inline-block; color:#065f46; }
    .confirm-notice{ 
      margin-top: 12px; 
      padding-top: 12px; 
      border-top: 1px solid color-mix(in oklab, var(--success) 20%, #fff);
      font-size: .95rem;
      color: var(--text-soft);
    }

    /* --- Loading overlay --- */
    .loading-overlay{ position: fixed; inset:0; background: rgba(2,6,23,.5); display:none; place-items:center; z-index: 9999; }
    .loading-overlay.active{ display:grid; }
    .loading-content{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 24px;
      text-align:center;
      box-shadow: var(--shadow-lg);
      color: var(--text);
    }
    .loading-content .spinner{
      width: 52px; height:52px; border: 5px solid var(--border);
      border-top-color: var(--primary); border-radius: 50%;
      animation: spin 1s linear infinite; margin: 0 auto 14px;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .info-notice{
      background: color-mix(in oklab, var(--primary) 8%, #ffffff);
      border: 1px solid color-mix(in oklab, var(--primary) 25%, var(--border));
      color: var(--text);
      padding: 14px;
      border-radius: 12px;
      margin-bottom: 20px;
      font-size: .95rem;
    }

    /* --- Responsive --- */
    @media (max-width: 768px){
      .form-row{ grid-template-columns: 1fr; }
      .button-group{ flex-direction: column; }
      .btn{ width: 100%; }
      .slot-grid{ grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
      .header{ padding: 28px 22px; }
      .form-container{ padding: 22px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>Still Waters – Physician Scheduler</h1>
      <p>In-office NP/MD visits • no telehealth • 15-minute start times</p>
    </div>

    <!-- Form -->
    <form id="physForm" class="form-container" novalidate>
      <!-- Toasts -->
      <div id="successMessage" class="success-message">Appointment booked! You’ll receive a confirmation shortly.</div>
      <div id="errorMessage" class="error-message">Something went wrong. Please try again.</div>

      <!-- Post-booking confirmation card -->
      <div id="confirmationCard" class="confirm-card" aria-live="polite">
        <h3>You're booked! 🎉</h3>
        <div class="confirm-row"><b>Date & time</b><span id="confWhen">—</span></div>
        <div class="confirm-row"><b>Clinic location</b><span id="confLocation">—</span></div>
        <div class="confirm-row"><b>Note</b><span id="confNote">Please check in at the front desk when you arrive.</span></div>
        <div class="confirm-actions">
          <a id="confOutlookLink" class="btn btn-secondary" href="#" target="_blank" rel="noopener" style="display:none">Open in Outlook</a>
        </div>
      </div>

      <!-- Person Receiving Services -->
      <div class="form-section">
        <h2>Person Receiving Services</h2>
        <div class="form-row">
          <div class="form-group">
            <label for="firstName">First Name <span class="required">*</span></label>
            <input type="text" id="firstName" name="firstName" autocomplete="given-name" required />
          </div>
          <div class="form-group">
            <label for="lastName">Last Name <span class="required">*</span></label>
            <input type="text" id="lastName" name="lastName" autocomplete="family-name" required />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="email">Email <span class="required">*</span></label>
            <input type="email" id="email" name="email" autocomplete="email" required />
          </div>
          <div class="form-group">
            <label for="phone">Phone <span class="required">*</span></label>
            <input type="tel" id="phone" name="phone" placeholder="123-456-7890" autocomplete="tel" required />
          </div>
        </div>
      </div>

      <!-- First-Time vs Follow-Up -->
      <div class="form-section">
        <h2>Visit Type</h2>
        <label>Is this your first time seeing a physician at Still Waters Professional Counseling? <span class="required">*</span></label>
        <div class="radio-group" style="margin-top:10px">
          <label class="radio-option">
            <input type="radio" id="firstYes" name="firstTime" value="yes" />
            <span>Yes, first-time (60 minutes)</span>
          </label>
          <label class="radio-option">
            <input type="radio" id="firstNo" name="firstTime" value="no" />
            <span>No, follow-up (30 minutes)</span>
          </label>
        </div>
        <p class="hint">Starts are offered every 15 minutes. First visits allow 60m (chosen in 30m steps for double-booking); follow-ups allow 30m (15m steps).</p>
      </div>

      <!-- Over 18 -->
      <div class="form-section">
        <h2>Age Verification</h2>
        <label>Is the person receiving services over 18? <span class="required">*</span></label>
        <div class="radio-group" style="margin-top:10px">
          <label class="radio-option">
            <input type="radio" id="over18Yes" name="over18" value="yes" />
            <span>Yes</span>
          </label>
          <label class="radio-option">
            <input type="radio" id="over18No" name="over18" value="no" />
            <span>No</span>
          </label>
        </div>
      </div>

      <!-- Guardian (shown only if under 18) -->
      <div id="guardianInfo" class="form-section hidden">
        <h2>Guardian Information</h2>
        <div class="form-row">
          <div class="form-group">
            <label for="guardianName">Guardian Name <span class="required">*</span></label>
            <input type="text" id="guardianName" name="guardianName" />
          </div>
          <div class="form-group">
            <label for="guardianPhone">Guardian Phone <span class="required">*</span></label>
            <input type="tel" id="guardianPhone" name="guardianPhone" placeholder="123-456-7890" />
          </div>
        </div>
      </div>

      <!-- Select Appointment Time -->
      <div class="form-section">
        <h2>Select Appointment Time</h2>
        <div class="form-group">
          <button type="button" class="btn btn-secondary" id="loadSlotsBtn">Load Available Times</button>
        </div>
        <div id="timeSlots" class="time-slots" aria-live="polite"></div>
        <p class="hint">Only start times are shown. End times are calculated automatically.</p>
      </div>

      <!-- Book -->
      <div class="button-group">
        <button type="button" class="btn btn-secondary" id="clearFormBtn">Clear Form</button>
        <button type="submit" class="btn btn-primary" id="submitBtn">
          Confirm Appointment
          <span class="loading-spinner hidden" id="submitSpinner"></span>
        </button>
      </div>
    </form>
  </div>

  <!-- Loading overlay -->
  <div id="loadingOverlay" class="loading-overlay" aria-hidden="true">
    <div class="loading-content">
      <div class="spinner" aria-hidden="true"></div>
      <p id="overlayMessage">Processing your request...</p>
    </div>
  </div>

  <script>
/* =========================
   Still Waters – Physician Scheduler JS
   v2025-09-15_physician_v1
   ========================= */

var CONFIG = {
  GET_SLOTS_URL: 'https://sw-function-b6c4h9cnexhbh4g3.canadacentral-01.azurewebsites.net/api/Calender',
  BOOK_APPOINTMENT_URL: 'https://sw-function-b6c4h9cnexhbh4g3.canadacentral-01.azurewebsites.net/api/CreateEvent',
  GET_SLOTS_KEY: '',
  BOOK_APPOINTMENT_KEY: '',
  TIMEZONE: 'Central Standard Time',
  CLINIC_NAME: 'Still Waters Professional Counseling – Clinic',
  // Fallback; can be overridden by ?address=... in the URL or injected by your app
  CLINIC_ADDRESS: 'Your clinic full address here'
};

/* -------------------------
   State
-------------------------- */
var availableSlots = [];     // parsed windows array
var selectedSlot = null;     // {y,m,d,start{hour,minute}, durationMin, stepMin}
var visitType = null;        // 'first' | 'followup'
var durationMin = 30;        // computed from visitType
var stepMin = 15;            // computed from visitType

/* -------------------------
   Utilities
-------------------------- */
function withKey(url, key) {
  if (!key) return url;
  try {
    var u = new URL(url);
    u.searchParams.set('code', key);
    return u.toString();
  } catch {
    var sep = url.indexOf('?') >= 0 ? '&' : '?';
    return url + sep + 'code=' + encodeURIComponent(key);
  }
}
function p2(n){ return (n<10?'0':'')+n; }
function generateUUID(){ 
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){ 
    var r=Math.random()*16|0, v=c==='x'?r:(r&0x3)|0x8; 
    return v.toString(16).toUpperCase(); 
  }); 
}
function convertTo24Hour(timeStr){
  var t=timeStr.trim().split(' ');
  var hm=t[0].split(':'), h=parseInt(hm[0],10), m=parseInt(hm[1],10), p=t[1];
  if(p==='PM'&&h!==12)h+=12;
  if(p==='AM'&&h===12)h=0;
  return {hours:h, minutes:m};
}
function hmToMinutes(h,m){ return h*60+m; }
function minutesToHM(total){ return {hour: Math.floor(total/60), minute: total%60}; }
function addMinutesToHM(h, m, delta){
  var total = h*60 + m + delta;
  return { hour: Math.floor(total/60), minute: total%60 };
}
function t12fmt(h, m){
  var ap=h>=12?'PM':'AM';
  var hh=h%12===0?12:(h%12);
  return hh + ':' + p2(m) + ' ' + ap;
}
function ymdhms(y,m,d,h,mi){ return y+'-'+p2(m)+'-'+p2(d)+'T'+p2(h)+':'+p2(mi)+':00'; }
function localDow(y,m,d){
  var days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  return days[new Date(y, m-1, d).getDay()];
}
function getQueryParam(name){
  var m = new RegExp('[?&]'+name+'=([^&#]*)').exec(window.location.search);
  return m ? decodeURIComponent(m[1].replace(/\+/g,'%20')) : null;
}
function referralAddressText(){
  return getQueryParam('address') || CONFIG.CLINIC_ADDRESS || '';
}

/* -------------------------
   Parsing free_slots windows
   Example: "15 Sep 2025, 03:40 PM - 05:00 PM"
-------------------------- */
function parseSlotString(slotStr){
  var parts = slotStr.split(', ');
  if (parts.length < 2) throw new Error('Unexpected slot format: '+slotStr);

  var datePart = parts[0]; // "15 Sep 2025"
  var timePart = parts[1]; // "03:40 PM - 05:00 PM"

  var [dayStr, monStr, yearStr] = datePart.split(' ');
  var day = parseInt(dayStr, 10), year = parseInt(yearStr, 10);
  var monthMap = {Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12};
  var monthNum = monthMap[monStr];
  if (!monthNum) throw new Error('Unknown month in slot: ' + slotStr);

  var [startStr, endStr] = timePart.split(' - ');
  var start24 = convertTo24Hour(startStr);
  var end24   = convertTo24Hour(endStr);

  return {
    y: year, m: monthNum, d: day,
    dateStr: datePart,
    startMin: hmToMinutes(start24.hours, start24.minutes),
    endMin:   hmToMinutes(end24.hours,   end24.minutes)
  };
}

function groupByDate(slots){
  var map = {};
  slots.forEach(s => {
    var key = s.y + '-' + p2(s.m) + '-' + p2(s.d);
    if (!map[key]) map[key] = { y:s.y, m:s.m, d:s.d, dateStr:s.dateStr, windows:[] };
    map[key].windows.push({ startMin: s.startMin, endMin: s.endMin });
  });
  return map;
}

/* -------------------------
   Visit Type (First-Time vs Follow-Up)
   - first-time: duration 60m, step 30m (double booking)
   - follow-up:  duration 30m, step 15m
-------------------------- */
function applyVisitTypeFromUI(){
  var sel = document.querySelector('input[name="firstTime"]:checked');
  if (!sel) { visitType = null; return; }
  visitType = (sel.value === 'yes') ? 'first' : 'followup';
  if (visitType === 'first'){ durationMin = 60; stepMin = 30; }
  else { durationMin = 30; stepMin = 15; }
}

/* -------------------------
   UI helpers (to match your existing form patterns)
-------------------------- */
function showSuccess(){ 
  hideMessages(); 
  var el=document.getElementById('successMessage'); 
  if (el){ el.style.display='block'; setTimeout(function(){ el.style.display='none'; }, 5000); }
}
function showError(msg){
  hideMessages();
  var el=document.getElementById('errorMessage');
  if (el){ el.textContent = msg; el.style.display='block'; setTimeout(function(){ el.style.display='none'; }, 6000); }
}
function hideMessages(){
  var s=document.getElementById('successMessage'), e=document.getElementById('errorMessage');
  if (s) s.style.display='none';
  if (e) e.style.display='none';
}
function overlay(on, text){
  var ov=document.getElementById('loadingOverlay');
  var msg=document.getElementById('overlayMessage');
  if (!ov) return;
  if (typeof text==='string' && msg) msg.textContent = text;
  ov.classList.toggle('active', !!on);
}

/* -------------------------
   Slots rendering (start-time chips only; no end times shown)
-------------------------- */
function displaySlots(slots){
  var container = document.getElementById('timeSlots');
  if (!container) return;
  container.innerHTML = '';
  selectedSlot = null;

  if (!visitType){
    container.innerHTML = '<p>Please choose if this is your first visit or a follow-up.</p>';
    return;
  }
  if (!slots || !slots.length){
    container.innerHTML = '<p>No available slots returned by the server. Please check back later.</p>';
    return;
  }

  // Normalize to parsed objects
  if (typeof slots[0] === 'string' || !('startMin' in slots[0])) {
    try { slots = slots.map(parseSlotString); }
    catch(e){ console.error(e); container.innerHTML = '<p>Could not parse slots from server.</p>'; return; }
  }

  var byDate = groupByDate(slots);
  var keys = Object.keys(byDate).sort();
  if (!keys.length){
    container.innerHTML = '<p>No availability found.</p>';
    return;
  }

  keys.forEach(function(key){
    var dayData = byDate[key];

    var card = document.createElement('div');
    card.className = 'time-slot';

    var header = document.createElement('div');
    header.className = 'date';
    header.textContent = localDow(dayData.y, dayData.m, dayData.d) + ' ' + dayData.dateStr;

    var grid = document.createElement('div');
    grid.className = 'slot-grid';

    var emitted = new Set();

    dayData.windows.forEach(function(w){
      // only emit starts that allow the full duration to fit
      for (var m = w.startMin; m + durationMin <= w.endMin; m += stepMin){
        if (emitted.has(m)) continue;
        emitted.add(m);

        var startHM = minutesToHM(m);

        var chip = document.createElement('div');
        chip.className = 'slot-chip';
        chip.setAttribute('role','button');
        chip.setAttribute('tabindex','0');
        chip.textContent = t12fmt(startHM.hour, startHM.minute); // START TIME ONLY

        chip.addEventListener('click', function(mm){
          return function(){
            document.querySelectorAll('.slot-chip').forEach(function(el){ el.classList.remove('selected'); });
            chip.classList.add('selected');

            selectedSlot = {
              y: dayData.y, m: dayData.m, d: dayData.d,
              start: minutesToHM(mm),
              durationMin: durationMin,
              stepMin: stepMin
            };
          };
        }(m));

        chip.addEventListener('keydown', function(ev){
          if (ev.key === 'Enter' || ev.key === ' '){ ev.preventDefault(); chip.click(); }
        });

        grid.appendChild(chip);
      }
    });

    if (grid.children.length === 0){
      var emptyMsg = document.createElement('div');
      emptyMsg.style.color = 'var(--muted)';
      emptyMsg.textContent = visitType==='first'
        ? 'No 60-minute starts (30-min steps) fit today.'
        : 'No 30-minute starts (15-min steps) fit today.';
      grid.appendChild(emptyMsg);
    }

    card.appendChild(header);
    card.appendChild(grid);
    container.appendChild(card);
  });
}

/* -------------------------
   Fetch free slots
-------------------------- */
async function loadAvailableSlots(){
  applyVisitTypeFromUI();
  if (!visitType){
    showError('Please select whether this is your first visit or a follow-up.');
    return;
  }
  overlay(true, 'Loading available times…');
  var url = withKey(CONFIG.GET_SLOTS_URL, CONFIG.GET_SLOTS_KEY);
  try{
    var resp = await fetch(url, { method:'GET', headers:{'Accept':'application/json'} });
    var text = await resp.text();
    if (!resp.ok) throw new Error('Failed to load slots ('+resp.status+')');
    var data = text ? JSON.parse(text) : {};
    var list = Array.isArray(data) ? data
             : (Array.isArray(data.free_slots) ? data.free_slots
             : (Array.isArray(data.freeSlots) ? data.freeSlots
             : (Array.isArray(data.slots) ? data.slots : [])));
    availableSlots = list.map(parseSlotString);
    displaySlots(availableSlots);
  }catch(e){
    console.error(e);
    showError('Failed to load available appointment times. Please try again.');
  }finally{
    overlay(false);
  }
}

/* -------------------------
   Validation
-------------------------- */
function validateForm(){
  hideMessages();
  if (!selectedSlot){ showError('Please choose a start time.'); return false; }

  var first = (document.getElementById('firstName')?.value||'').trim();
  var last  = (document.getElementById('lastName')?.value||'').trim();
  var email = (document.getElementById('email')?.value||'').trim();
  var phone = (document.getElementById('phone')?.value||'').trim();
  if (!first || !last){ showError('Please enter your first and last name.'); return false; }
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ showError('Please enter a valid email.'); return false; }
  if (phone.length < 7){ showError('Please enter a valid phone number.'); return false; }

  var over = document.querySelector('input[name="over18"]:checked');
  if (!over){ showError('Please confirm if the person is over 18.'); return false; }

  if (over.value === 'no'){
    var gn = (document.getElementById('guardianName')?.value||'').trim();
    var gp = (document.getElementById('guardianPhone')?.value||'').trim();
    if (!gn || gp.length < 7){ showError('Please provide guardian name and phone.'); return false; }
  }

  var ft = document.querySelector('input[name="firstTime"]:checked');
  if (!ft){ showError('Please select First-Time or Follow-Up.'); return false; }

  return true;
}

/* -------------------------
   Confirmation (no provider names; in-office address + check-in)
-------------------------- */
function showConfirmation(opts){
  // Expecting a card with: #confirmationCard, #confWhen, #confLocation, #confNote, #confOutlookLink (optional)
  var card = document.getElementById('confirmationCard');
  if (!card) return;

  var confWhen = document.getElementById('confWhen');
  var confLocation = document.getElementById('confLocation');
  var confNote = document.getElementById('confNote');
  var outlookLink = document.getElementById('confOutlookLink');

  if (confWhen) confWhen.textContent = opts.whenText || '—';
  if (confLocation) confLocation.textContent = opts.locationText || referralAddressText();
  if (confNote) confNote.textContent = 'Please check in at the front desk when you arrive.';
  if (outlookLink && opts.webLink) { outlookLink.href = opts.webLink; outlookLink.style.display='inline-flex'; }
  else if (outlookLink) { outlookLink.removeAttribute('href'); outlookLink.style.display='none'; }

  card.classList.add('visible');
  card.scrollIntoView({ behavior:'smooth', block:'center' });
}

function friendlyStartFromSelected(){
  var y=selectedSlot.y, m=selectedSlot.m, d=selectedSlot.d;
  var s=selectedSlot.start;
  var mons=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return d+' '+mons[m-1]+' '+y+', '+t12fmt(s.hour, s.minute);
}

/* -------------------------
   Submit -> Create event (Outlook via your Azure Function)
-------------------------- */
async function handleSubmit(e){
  e.preventDefault();
  if (!validateForm()) return;

  var btn=document.getElementById('submitBtn');
  var spin=document.getElementById('submitSpinner');
  if (btn) btn.disabled = true;
  if (spin) spin.classList?.remove('hidden');
  overlay(true, 'Submitting your booking…');

  try{
    var first=(document.getElementById('firstName')?.value||'').trim();
    var last =(document.getElementById('lastName')?.value||'').trim();
    var email=(document.getElementById('email')?.value||'').trim();
    var phone=(document.getElementById('phone')?.value||'').trim();

    // Stick a little convenience for prefill next time
    try {
      localStorage.setItem('sw_client_name', first+' '+last);
      localStorage.setItem('sw_client_phone', phone);
    } catch {}

    var over = document.querySelector('input[name="over18"]:checked')?.value || 'yes';
    var guardian = null;
    if (over === 'no'){
      guardian = {
        name: (document.getElementById('guardianName')?.value||'').trim(),
        phone:(document.getElementById('guardianPhone')?.value||'').trim()
      };
    }

    applyVisitTypeFromUI(); // ensure durationMin/stepMin set

    // Compute start/end in local clinic tz (server will store w/ timeZone)
    var stH = selectedSlot.start.hour, stM = selectedSlot.start.minute;
    var endHM = addMinutesToHM(stH, stM, durationMin);

    var startDT = ymdhms(selectedSlot.y, selectedSlot.m, selectedSlot.d, stH, stM);
    var endDT   = ymdhms(selectedSlot.y, selectedSlot.m, selectedSlot.d, endHM.hour, endHM.minute);

    // Subject + body (no provider names shown)
    var subject = 'Physician visit – ' + (visitType==='first' ? 'First-Time (60m)' : 'Follow-Up (30m)');
    var addressText = referralAddressText();
    var bodyParts = [
      'In-office physician visit for ' + first + ' ' + last + '.',
      'When: ' + friendlyStartFromSelected() + ' (' + CONFIG.TIMEZONE + ')',
      'Where: ' + (addressText || CONFIG.CLINIC_NAME),
      'Check-in: Please check in at the front desk when you arrive.',
      'Contact: ' + phone,
      '',
      'Need to cancel or reschedule? Reply to this message or call the office.',
      'You’ll receive reminders 48h and 24h before your appointment.'
    ];
    if (over === 'no' && guardian){
      bodyParts.splice(3,0,'Guardian: ' + guardian.name + ' (' + guardian.phone + ')');
    }
    var body = bodyParts.join('\n');

    var payload = {
      subject: subject,
      body: body,
      start: { dateTime: startDT, timeZone: CONFIG.TIMEZONE },
      end:   { dateTime: endDT,   timeZone: CONFIG.TIMEZONE },
      expectedDate: selectedSlot.y + '-' + p2(selectedSlot.m) + '-' + p2(selectedSlot.d),
      location: { displayName: 'In-Office — ' + (addressText || CONFIG.CLINIC_NAME) },
      attendees: [{ address: email, name: first+' '+last, type:'required' }],
      allowNewTimeProposals: true,
      transactionId: generateUUID(),
      visitType: visitType,           // 'first' | 'followup' (for your backend if you want it)
      over18: over,
      guardian: guardian
    };

    var url = withKey(CONFIG.BOOK_APPOINTMENT_URL, CONFIG.BOOK_APPOINTMENT_KEY);
    var resp = await fetch(url, {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
      body: JSON.stringify(payload)
    });

    if (!resp.ok){
      var t=''; try{ t=await resp.text(); }catch(_){}
      throw new Error('Failed to book ('+resp.status+') '+t);
    }

    var result = await resp.json();

    // UI success + confirmation card
    showSuccess();
    showConfirmation({
      whenText: friendlyStartFromSelected(),
      locationText: addressText,
      webLink: result?.webLink || null
    });

  }catch(err){
    console.error(err);
    showError('There was an error booking your appointment. Please try again or call the office.');
  }finally{
    if (btn) btn.disabled=false;
    if (spin) spin.classList?.add('hidden');
    overlay(false);
  }
}

/* -------------------------
   Misc: Prefill + guardian toggle + phone mask
-------------------------- */
function formatPhoneInput(el){
  if (!el) return;
  el.addEventListener('input', function(e){
    var v = e.target.value.replace(/\D/g,'').slice(0,10);
    if (v.length>6) e.target.value = v.slice(0,3)+'-'+v.slice(3,6)+'-'+v.slice(6);
    else if (v.length>3) e.target.value = v.slice(0,3)+'-'+v.slice(3);
    else e.target.value = v;
  });
}

function toggleGuardianSection(){
  var over = document.querySelector('input[name="over18"]:checked');
  var sec = document.getElementById('guardianInfo');
  if (!sec) return;
  if (over && over.value === 'no'){
    sec.classList.remove('hidden');
    var gn=document.getElementById('guardianName');
    var gp=document.getElementById('guardianPhone');
    if (gn) gn.required = true;
    if (gp) gp.required = true;
  } else {
    sec.classList.add('hidden');
    var gn=document.getElementById('guardianName');
    var gp=document.getElementById('guardianPhone');
    if (gn){ gn.required = false; gn.value=''; }
    if (gp){ gp.required = false; gp.value=''; }
  }
}

function prefillFromStorageOrQuery(){
  try {
    var nm = getQueryParam('name') || localStorage.getItem('sw_client_name');
    var ph = getQueryParam('phone') || localStorage.getItem('sw_client_phone');
    if (nm){
      var parts = nm.trim().split(' ');
      var first = parts.shift() || '';
      var last  = parts.join(' ') || '';
      if (document.getElementById('firstName')) document.getElementById('firstName').value = first;
      if (document.getElementById('lastName'))  document.getElementById('lastName').value  = last;
    }
    if (ph && document.getElementById('phone')){
      document.getElementById('phone').value = ph;
    }
  } catch {}
}

/* -------------------------
   Wire-up
-------------------------- */
document.addEventListener('DOMContentLoaded', function () {
  // Phone masks
  formatPhoneInput(document.getElementById('phone'));
  formatPhoneInput(document.getElementById('guardianPhone'));

  // Over 18 radios
  document.querySelectorAll('input[name="over18"]').forEach(function(r){
    r.addEventListener('change', toggleGuardianSection);
  });

  // First-time vs follow-up radios: update visitType and re-render chips if we already loaded windows
  document.querySelectorAll('input[name="firstTime"]').forEach(function(r){
    r.addEventListener('change', function(){
      applyVisitTypeFromUI();
      if (availableSlots.length){ displaySlots(availableSlots); }
    });
  });

  // Load slots
  document.getElementById('loadSlotsBtn')?.addEventListener('click', loadAvailableSlots);

  // Submit
  document.getElementById('physForm')?.addEventListener('submit', handleSubmit);

  // Clear (optional button)
  document.getElementById('clearFormBtn')?.addEventListener('click', function(){
    document.getElementById('physForm')?.reset();
    selectedSlot = null;
    availableSlots = [];
    visitType = null;
    durationMin = 30;
    stepMin = 15;
    var ts = document.getElementById('timeSlots'); if (ts) ts.innerHTML='';
    hideMessages();
    var card = document.getElementById('confirmationCard'); if (card) card.classList.remove('visible');
    toggleGuardianSection();
  });

  // Prefill
  prefillFromStorageOrQuery();

  // Initialize guardian section hidden
  toggleGuardianSection();
});
</script>

</body>

</html>