<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Still Waters - Schedule Physician Appointment</title>
  <link rel="icon" type="image/x-icon" href="./favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
  <link rel="manifest" href="./site.webmanifest">

  <style>
    /* --- Reset & Tokens --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root{
      /* Palette */
      --primary: #4f46e5;
      --primary-700:#4338ca;
      --secondary:#06b6d4;
      --accent: #38bdf8;
      --success: #10b981;
      --danger: #ef4444;

      /* Neutrals */
      --bg: #f6f7fb;
      --card: #ffffff;
      --muted: #6b7280;
      --text: #0f172a;
      --text-soft:#334155;
      --border: #e5e7eb;

      /* Elevation */
      --shadow: 0 8px 24px rgba(2, 6, 23, .08);
      --shadow-lg: 0 18px 40px rgba(2, 6, 23, .12);

      /* Focus ring */
      --ring: rgba(79, 70, 229, .45);
      --ring-strong: rgba(6, 182, 212, .45);

      /* Radii */
      --r-lg: 20px;
      --r-xl: 24px;
      --r-full: 9999px;

      /* Transitions */
      --t-fast: .15s ease;
      --t-med: .25s ease;

      /* Slot sizing */
      --chip-min: 120px;
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg: #0b1220;
        --card: #0f172a;
        --text: #e5e7eb;
        --text-soft:#cbd5e1;
        --border: #1f2937;
        --shadow: 0 8px 24px rgba(0,0,0,.5);
        --shadow-lg: 0 18px 50px rgba(0,0,0,.55);
        --ring: rgba(56, 189, 248, .5);
        --ring-strong: rgba(99, 102, 241, .55);
      }
    }

    /* --- Page --- */
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      padding: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(79,70,229,.14), transparent 60%),
        radial-gradient(800px 500px at 90% 10%, rgba(6,182,212,.16), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg));
    }

    .container{
      width: 100%;
      max-width: 800px;
      background: linear-gradient(0deg, rgba(255,255,255,.6), rgba(255,255,255,.6)), var(--card);
      backdrop-filter: saturate(120%) blur(6px);
      border: 1px solid var(--border);
      border-radius: var(--r-xl);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      animation: slideIn .4s ease-out both;
    }

    @keyframes slideIn{ from{ opacity:0; transform: translateY(18px);} to{ opacity:1; transform: translateY(0);} }

    /* --- Header --- */
   .header{
      padding:40px 32px;
      color:#fff;
      background:linear-gradient(135deg, var(--primary), var(--secondary));
      text-align:center;
    }

    .header img.logo{
      max-width:100px;
      height:auto;
      display:block;
      margin:0 auto 16px auto;
      filter: drop-shadow(0 3px 6px rgba(0,0,0,0.2));
    }
        .header .call-line{
      font-size:1rem;
      margin-top:10px;
      color:#e0eaff;
      font-weight:600;
    }
    .header h1{
      font-size: clamp(1.8rem, 2.6vw, 2.6rem);
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 8px;
    }
    .header p{
      font-size: 1.05rem;
      opacity: .95;
    }

    /* --- Form layout --- */
    .form-container{ padding: 32px; }
    .form-section{ margin-bottom: 28px; animation: fadeIn .35s ease-out both; }
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }

    .form-section h2{
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 16px;
    }

    .form-group{ margin-bottom: 16px; }
    .form-row{ display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }

    label{
      display: block;
      color: var(--text-soft);
      font-weight: 600;
      margin-bottom: 8px;
      font-size: .95rem;
    }
    .required{ color: var(--danger); }

    /* --- Inputs --- */
    input[type="text"],
    input[type="tel"],
    select{
      width: 100%;
      appearance: none;
      background: var(--card);
      color: var(--text);
      border: 1.5px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 1rem;
      transition: border-color var(--t-fast), box-shadow var(--t-fast), background var(--t-fast), transform var(--t-fast);
    }

    input:hover, select:hover{
      border-color: color-mix(in oklab, var(--primary) 25%, var(--border));
    }
    input:focus, select:focus{
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--ring);
    }

    /* --- Choice groups --- */
    .radio-group{ display:flex; gap:14px; flex-wrap:wrap; margin-top: 8px; }
    .radio-option{
      display:flex; align-items:center; gap:10px;
      background: var(--card);
      border: 1.5px solid var(--border);
      border-radius: 12px;
      padding: 12px 16px;
      cursor: pointer;
      transition: transform var(--t-fast), box-shadow var(--t-fast), border-color var(--t-fast), background var(--t-fast);
      user-select: none;
    }
    .radio-option:hover{ transform: translateY(-1px); border-color: var(--primary); box-shadow: var(--shadow); }
    .radio-option.selected{
      border-color: var(--primary);
      background: linear-gradient(0deg, rgba(79,70,229,.06), rgba(6,182,212,.06));
      box-shadow: inset 0 0 0 1.5px color-mix(in oklab, var(--primary) 60%, transparent);
    }
    .radio-option input[type="radio"]{ width: 18px; height: 18px; }

    /* --- Slots --- */
    .time-slots{ display: grid; grid-template-columns: 1fr; gap: 16px; margin-top: 14px; }
    .time-slot{
      background: var(--card);
      border: 1.5px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .time-slot .date{ font-weight: 800; font-size: 1rem; color: var(--text); margin-bottom: 6px; }
    .time-slot .range{ color: var(--muted); font-size: .95rem; margin-bottom: 12px; }

    .slot-grid{ display: grid; grid-template-columns: repeat(auto-fill, minmax(var(--chip-min), 1fr)); gap: 10px; }
    .slot-chip{
      padding: 10px 12px;
      text-align: center;
      border-radius: var(--r-full);
      background: linear-gradient(180deg, #ffffff, #fafafa);
      color: var(--text);
      border: 1.5px solid var(--border);
      font-weight: 600;
      font-size: .95rem;
      cursor: pointer;
      transition: transform var(--t-fast), box-shadow var(--t-fast), border-color var(--t-fast), background var(--t-fast), color var(--t-fast);
    }
    .slot-chip:hover{ transform: translateY(-1px); border-color: var(--primary); box-shadow: var(--shadow); }
    .slot-chip:focus-visible{ outline: 0; box-shadow: 0 0 0 4px var(--ring-strong); }
    .slot-chip.selected{
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #fff;
      border-color: transparent;
      box-shadow: 0 8px 26px rgba(79,70,229,.35);
    }

    .hidden{ display:none !important; }

    /* --- Buttons --- */
    .button-group{ display:flex; gap: 12px; justify-content:center; margin-top: 28px; flex-wrap: wrap; }
    .btn{
      border: 0; border-radius: 12px;
      padding: 14px 28px;
      font-size: 1.05rem; font-weight: 800; letter-spacing: .02em;
      cursor: pointer;
      transition: transform var(--t-med), box-shadow var(--t-med), opacity var(--t-fast);
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .btn-primary{
      color:#fff;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      box-shadow: 0 10px 28px rgba(79,70,229,.35);
    }
    .btn-primary:hover:not(:disabled){ transform: translateY(-2px); box-shadow: 0 16px 40px rgba(79,70,229,.45); }

    .btn-secondary{
      color: var(--primary);
      background: linear-gradient(180deg, #ffffff, #fafafa);
      border: 1.5px solid color-mix(in oklab, var(--primary) 22%, var(--border));
    }
    .btn-secondary:hover{ transform: translateY(-2px); box-shadow: var(--shadow); }

    /* --- Alerts --- */
    .success-message,
    .error-message{
      display:none;
      border-radius: 12px;
      padding: 14px 16px;
      font-weight: 700;
      margin: 14px 0;
      box-shadow: var(--shadow);
      animation: slideDown .35s ease-out both;
    }
    @keyframes slideDown{ from{opacity:0; transform: translateY(-6px)} to{opacity:1; transform: translateY(0)} }

    .success-message{ background: color-mix(in oklab, var(--success) 18%, #ecfdf5); color: #065f46; border: 1.5px solid color-mix(in oklab, var(--success) 40%, #ffffff); }
    .error-message{ background: color-mix(in oklab, var(--danger) 18%, #fef2f2); color: #7f1d1d; border: 1.5px solid color-mix(in oklab, var(--danger) 40%, #ffffff); }

    /* --- Confirmation card --- */
    .confirm-card{
      display:none;
      background: color-mix(in oklab, var(--success) 10%, #fff);
      border: 1.5px solid color-mix(in oklab, var(--success) 30%, #fff);
      border-radius: 16px;
      padding: 18px;
      box-shadow: var(--shadow);
      margin: 16px 0;
    }
    .confirm-card.visible{ display:block; }
    .confirm-card h3{ font-size:1.15rem; font-weight:800; margin-bottom:8px; color:#065f46; }
    .confirm-row{ display:flex; gap:10px; align-items:flex-start; margin:6px 0; color:#064e3b; }
    .confirm-row b{ min-width:130px; display:inline-block; color:#065f46; }
    .confirm-notice{ 
      margin-top: 12px; 
      padding-top: 12px; 
      border-top: 1px solid color-mix(in oklab, var(--success) 20%, #fff);
      font-size: .95rem;
      color: var(--text-soft);
    }

    /* --- Loading overlay --- */
    .loading-overlay{ position: fixed; inset:0; background: rgba(2,6,23,.5); display:none; place-items:center; z-index: 9999; }
    .loading-overlay.active{ display:grid; }
    .loading-content{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 24px;
      text-align:center;
      box-shadow: var(--shadow-lg);
      color: var(--text);
    }
    .loading-content .spinner{
      width: 52px; height:52px; border: 5px solid var(--border);
      border-top-color: var(--primary); border-radius: 50%;
      animation: spin 1s linear infinite; margin: 0 auto 14px;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .info-notice{
      background: color-mix(in oklab, var(--primary) 8%, #ffffff);
      border: 1px solid color-mix(in oklab, var(--primary) 25%, var(--border));
      color: var(--text);
      padding: 14px;
      border-radius: 12px;
      margin-bottom: 20px;
      font-size: .95rem;
    }

    /* --- Responsive --- */
    @media (max-width: 768px){
      .form-row{ grid-template-columns: 1fr; }
      .button-group{ flex-direction: column; }
      .btn{ width: 100%; }
      .slot-grid{ grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
      .header{ padding: 28px 22px; }
      .form-container{ padding: 22px; }
    }
    /* Patch: ensure email input matches other inputs */
input[type="email"]{
  width: 100%;
  appearance: none;
  background: var(--card);
  color: var(--text);
  border: 1.5px solid var(--border);
  border-radius: 12px;
  padding: 12px 14px;
  font-size: 1rem;
  transition: border-color var(--t-fast), box-shadow var(--t-fast), background var(--t-fast), transform var(--t-fast);
}

/* Patch: tiny loading spinner shown inside the submit button */
.loading-spinner{
  display:inline-block;
  width: 14px; height: 14px;
  margin-left: 8px;
  border: 2px solid var(--border);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin .8s linear infinite;
  vertical-align: -2px;
}

/* Patch: confirmation action row spacing */
.confirm-actions{
  display: flex;
  gap: 10px;
  margin-top: 12px;
  flex-wrap: wrap;
}

/* ===== Two-flow layout ===== */
.flow-grid{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 22px;
  margin-top: 8px;
}
.flow-card{
  background: var(--card);
  border: 1.5px solid var(--border);
  border-radius: 16px;
  padding: 18px;
  box-shadow: var(--shadow);
  align-items: center;
}
.flow-title{
  font-weight: 900;
  color: var(--text);
  margin-bottom: 8px;
  font-size: 1.1rem;
  letter-spacing: .2px;
}
.flow-toggle{
  display:flex; gap:10px; align-items:flex-start;
  background: color-mix(in oklab, var(--accent) 10%, #fff);
  border: 1px dashed color-mix(in oklab, var(--accent) 40%, #fff);
  padding: 12px; border-radius: 12px; margin: 12px 0 16px;
}
.flow-toggle input[type="checkbox"]{ margin-top: 2px; }

/* Choice groups styled like your radios, but for checkboxes too */
.choice-group{ display:flex; gap:14px; flex-wrap:wrap; margin-top: 8px; }
.choice-option{
  display:flex; align-items:center; gap:10px;
  background: var(--card);
  border: 1.5px solid var(--border);
  border-radius: 12px;
  padding: 12px 16px;
  cursor: pointer;
  transition: transform var(--t-fast), box-shadow var(--t-fast), border-color var(--t-fast), background var(--t-fast);
  user-select: none;
}
.choice-option:hover{ transform: translateY(-1px); border-color: var(--primary); box-shadow: var(--shadow); }
.choice-option input{ width:18px; height:18px; }

/* Individuals list cards */
.person-card{
  background: var(--card);
  border: 1.5px solid var(--border);
  border-radius: 14px;
  padding: 14px;
  box-shadow: var(--shadow);
  margin-bottom: 12px;
}
.person-header{ display:flex; justify-content: space-between; align-items:center; margin-bottom: 10px; }
.person-title{ font-weight: 700; color: var(--text); }

/* Minor */
.section-hint{ color: var(--muted); font-size: .92rem; margin-top: 6px; }

/* Responsive: stack flows on small screens */
@media (max-width: 768px){
  .flow-grid{ grid-template-columns: 1fr; }
}

/* ===== UI polish pack (append to end of your CSS) ===== */

/* Roomier canvas for two-column flows */
.container{ max-width: 1100px; }

/* Flow cards: subtle lift + border emphasis on hover */
.flow-card{
  transition: transform var(--t-fast), box-shadow var(--t-fast), border-color var(--t-fast);
}
.flow-card:hover{
  transform: translateY(-2px);
  border-color: color-mix(in oklab, var(--primary) 30%, var(--border));
  box-shadow: 0 12px 30px rgba(2,6,23,.12);
}

/* Make "selected" states auto-highlight when inputs are checked */
.radio-option:has(input:checked),
.choice-option:has(input:checked){
  border-color: var(--primary);
  background: linear-gradient(0deg, rgba(79,70,229,.06), rgba(6,182,212,.06));
  box-shadow: inset 0 0 0 1.5px color-mix(in oklab, var(--primary) 55%, transparent);
}
.radio-option input:focus-visible,
.choice-option input:focus-visible{
  outline: none;
}
.radio-option:has(input:focus-visible),
.choice-option:has(input:focus-visible){
  box-shadow: 0 0 0 4px var(--ring);
}

/* Slot chips are buttons now â€” improve focus ring & tap targets */
.slot-chip{
  appearance: none;
  border: 1.5px solid var(--border);
  background: linear-gradient(180deg, #ffffff, #fafafa);
  min-height: 40px;
}
.slot-chip:focus-visible{
  outline: 0;
  box-shadow: 0 0 0 4px var(--ring-strong), 0 8px 22px rgba(2,6,23,.10);
}

/* Confirmation card: a bit more presence */
.confirm-card{
  border-color: color-mix(in oklab, var(--success) 35%, #fff);
  background: linear-gradient(0deg, color-mix(in oklab, var(--success) 8%, #fff), #fff);
}
.confirm-card.visible{
  animation: slideDown .35s ease-out both;
}

/* Confirm actions: keep spacing tidy on wrap */
.confirm-actions{
  gap: 12px;
}

/* Person card remove button */
.person-card .btn-remove{
  border: 1px dashed var(--border);
  background: transparent;
  color: var(--muted);
  padding: 6px 10px;
  border-radius: var(--r-full);
  cursor: pointer;
  transition: border-color var(--t-fast), color var(--t-fast), transform var(--t-fast);
}
.person-card .btn-remove:hover{
  color: var(--danger);
  border-color: color-mix(in oklab, var(--danger) 50%, var(--border));
  transform: translateY(-1px);
}

/* Flow toggle: friendlier emphasis */
.flow-toggle{
  background: color-mix(in oklab, var(--accent) 12%, #fff);
  border-color: color-mix(in oklab, var(--accent) 45%, #fff);
}

/* Buttons: slightly crisper hover lift */
.btn-primary{ box-shadow: 0 10px 28px rgba(79,70,229,.35); }
.btn-primary:hover:not(:disabled){ transform: translateY(-2px); box-shadow: 0 18px 42px rgba(79,70,229,.48); }
.btn-secondary:hover{ transform: translateY(-2px); box-shadow: 0 10px 26px rgba(2,6,23,.12); }
 .emergency-notice{
      display: flex; align-items: center; justify-content: center; gap: 10px;
      padding: 14px 18px; color: #fff;
      background: linear-gradient(135deg, #f43f5e, #ef4444);
      border-bottom: 1px solid rgba(255,255,255,.25);
      font-weight: 600;
      border-radius: 30px;
    }
    .emergency-notice svg{ width: 22px; height: 22px; }

/* Mobile: give a bit more breathing room between flow cards */
@media (max-width: 768px){
  .flow-grid{ gap: 16px; }
}

/* ===== NEW: Flow Control CSS ===== */
/* Hide flow contents by default */
.flow-card > .form-section,
.flow-card > .btn-secondary { /* Targets #addIndividualBtn */
  display: none;
}

/* When active, show them */
.flow-card.flow-active > .form-section,
.flow-card.flow-active > .btn-secondary {
  display: block;
}

#loadSlotsGuardianBtn {
            display: none;
        }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
  
      <h1>Still Waters Professional Counseling Services, Inc</h1>
      <h2>Schedule Your Appointment with a Physician/Nurse practioner.</h2>
      
      <div class="call-line">
        If you prefer to make your appointment by speaking to a Still Waterâ€™s employee call:<br>
        <strong>706-955-9224</strong>
      </div>
       <div class="emergency-notice">
       <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/></svg>
       <span>If you are experiencing an emergency, please dial 911 immediately</span>
     </div>
    </div>

    <form id="physForm" class="form-container" novalidate>
      <div id="successMessage" class="success-message">Appointment booked! Youâ€™ll receive a confirmation shortly.</div>
<div id="errorMessage" class="error-message">Something went wrong. Please try again.</div>

<div id="confirmationCard" class="confirm-card" aria-live="polite">
  <h3>You're booked! ðŸŽ‰</h3>
  <div class="confirm-row"><b>Date & time</b><span id="confWhen">â€”</span></div>
  <div class="confirm-row"><b>Clinic location</b><span id="confLocation">â€”</span></div>
  <div class="confirm-row"><b>Note</b><span id="confNote">Please check in at the front desk when you arrive.</span></div>
  <div class="confirm-actions">
    <a id="confOutlookLink" class="btn btn-secondary" href="#" target="_blank" rel="noopener" style="display:none">Open in Outlook</a>
  </div>
</div>

<div class="flow-grid">

  <div class="flow-card" id="flowSelf">
    <div class="flow-title">Individual (18+)</div>

    <div class="flow-toggle">
      <input type="checkbox" id="selfConfirm18"/>
      <label for="selfConfirm18">I am an individual making an appointment with the physician and confirm that I am over the age of 18 <span class="required">*</span></label>
    </div>

    <div class="form-section">
      <h2>Your Information</h2>
      <div class="form-row">
        <div class="form-group">
          <label for="selfFirstName">First Name <span class="required">*</span></label>
          <input type="text" id="selfFirstName" autocomplete="given-name"/>
        </div>
        <div class="form-group">
          <label for="selfLastName">Last Name <span class="required">*</span></label>
          <input type="text" id="selfLastName" autocomplete="family-name"/>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="selfEmail">Email Address</label>
          <input type="email" id="selfEmail" autocomplete="email"/>
        </div>
        <div class="form-group">
          <label for="selfPhone">Phone Number <span class="required">*</span></label>
          <input type="tel" id="selfPhone" placeholder="123-456-7890" autocomplete="tel"/>
        </div>
      </div>
      <div class="form-group">
        <label for="selfDob">BirthDate <span class="required">*</span></label>
        <input type="date" id="selfDob"/>
      </div>
    </div>

    <div class="form-section">
      <h2>Preferred Location</h2>
      <div class="choice-group">
        <label class="choice-option">
          <input type="checkbox" id="selfLocAugusta" value="3711 Executive Center Dr. Augusta, GA 30907"/>
          <span>3711 Executive Center Dr. Augusta, GA 30907</span>
        </label>
        <label class="choice-option">
          <input type="checkbox" id="selfLocMacon" value="640 Plum Street Suites 202 and 203 Macon, GA 30201"/>
          <span>640 Plum Street Suites 203 Macon, GA 30201</span>
        </label>
      </div>
      <p class="section-hint">Select your preferred clinic location.</p>
    </div>

    <div class="form-section">
      <h2>Visit Type</h2>
      <div class="radio-group">
        <label class="radio-option">
          <input type="radio" name="firstTimeSelf" value="yes"/>
          <span>Yes, first time (60 minutes)</span>
        </label>
        <label class="radio-option">
          <input type="radio" name="firstTimeSelf" value="no"/>
          <span>No, follow-up (30 minutes)</span>
        </label>
      </div>
      <p class="section-hint">Starts offered every 15 minutes; first-time visits book 60m, follow-ups 30m.</p>
    </div>

    <div class="form-section">
      <h2>Select Appointment Time</h2>
      <div class="form-group">
        <button type="button" class="btn btn-secondary" id="loadSlotsSelfBtn">Load Available Times</button>
      </div>
      <div id="timeSlotsSelf" class="time-slots" aria-live="polite"></div>
      <p class="section-hint">Only start times are shown. End time is calculated automatically.</p>
    </div>

   

    <div class="form-section">
      <h2>Consent &amp; Acknowledgements</h2>
      <label class="choice-option">
        <input type="checkbox" id="selfConsent"/>
        <span>I consent to receiving reminders via text and email <span class="required">*</span></span>
      </label>
      <label class="choice-option" style="margin-top:10px">
        <input type="checkbox" id="selfEmergency"/>
        <span>I confirm that I am not experiencing a medical or mental health emergency <span class="required">*</span></span>
      </label>
    </div>
  </div>

  <div class="flow-card" id="flowGuardian">
    <div class="flow-title">Parent or Guardian (18+)</div>

    <div class="flow-toggle">
      <input type="checkbox" id="guardianConfirm18"/>
      <label for="guardianConfirm18">I am parent or guardian of an individual(s) making an appointment with the physician and confirm I am over the age of 18 <span class="required">*</span></label>
    </div>

    <div class="form-section">
      <h2>Parent/Guardian Information</h2>
      <div class="form-row">
        <div class="form-group">
          <label for="guardFirstName">First Name (Parent or Guardian) <span class="required">*</span></label>
          <input type="text" id="guardFirstName"/>
        </div>
        <div class="form-group">
          <label for="guardLastName">Last Name (Parent or Guardian) <span class="required">*</span></label>
          <input type="text" id="guardLastName"/>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="guardEmail">Email Address (Parent or Guardian)</label>
          <input type="email" id="guardEmail"/>
        </div>
        <div class="form-group">
          <label for="guardPhone">Phone Number (Parent or Guardian) <span class="required">*</span></label>
          <input type="tel" id="guardPhone" placeholder="123-456-7890"/>
        </div>
      </div>
    </div>

    <div class="form-section">
      <h2><b>Individuals Seeking Services</b></h2>

      <div id="individualsList">
        <div class="person-card">
          <div class="person-header">
            <span class="person-title">Individual</span>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>First Name <span class="required">*</span></label>
              <input type="text"/>
            </div>
            <div class="form-group">
              <label>Last Name <span class="required">*</span></label>
              <input type="text"/>
            </div>
          </div>
          <div class="form-group">
            <label>BirthDate <span class="required">*</span></label>
            <input type="date"/>
          </div>
        </div>
      </div>

      <button type="button" class="btn btn-secondary" id="addIndividualBtn">+ Individuals</button>
      <p class="section-hint">Add each person who will be seen by the physician.</p>
    </div>

    <div class="form-section">
      <h2>Preferred Location</h2>
      <div class="choice-group">
        <label class="choice-option">
          <input type="checkbox" id="guardLocAugusta" value="3711 Executive Center Dr. Augusta, GA 30907"/>
          <span>3711 Executive Center Dr. Augusta, GA 30907</span>
        </label>
        <label class="choice-option">
          <input type="checkbox" id="guardLocMacon" value="640 Plum Street Suites 202 and 203 Macon, GA 30201"/>
          <span>640 Plum Street Suites 203 Macon, GA 30201</span>
        </label>
      </div>
    </div>

    <div class="form-section">
      <h2>Visit Type (Per Individual)</h2>
      <div class="radio-group">
        <label class="radio-option">
          <input type="radio" name="firstTimeGuardian" value="yes"/>
          <span>Yes, first time (60 minutes)</span>
        </label>
        <label class="radio-option">
          <input type="radio" name="firstTimeGuardian" value="no"/>
          <span>No, follow-up (30 minutes)</span>
        </label>
      </div>
    </div>

    <div class="form-section">
      <h2>Available Slots</h2>
      <div class="form-group">
        <button type="button" class="btn btn-secondary" id="loadSlotsGuardianBtn">Load Available Times</button>
      </div>
      <div id="timeSlotsGuardian" class="time-slots" aria-live="polite"></div>
      <p class="section-hint">Available times are calculated based on the number of individuals and visit type selected.</p>
    </div>

    <div class="form-section">
      <h2>Additional Information</h2>
      <div class="form-group">
        <label for="guardAltAvailability">Alternate Availability (Optional)</label>
        <input type="text" id="guardAltAvailability" placeholder="If listed slots donâ€™t work, describe your availability"/>
      </div>
      <div class="form-group">
        <label for="guardNotes">Additional Notes (Optional)</label>
        <input type="text" id="guardNotes" placeholder="Anything else youâ€™d like us to know"/>
      </div>
    </div>

    <div class="form-section">
      <h2>Consent &amp; Acknowledgements</h2>
      <label class="choice-option">
        <input type="checkbox" id="guardConsent"/>
        <span>I consent to receiving reminders via text and email <span class="required">*</span></span>
      </label>
      <label class="choice-option" style="margin-top:10px">
        <input type="checkbox" id="guardEmergency"/>
        <span>I confirm that I am not experiencing a medical or mental health emergency <span class="required">*</span></span>
      </label>
    </div>
  </div>
</div>

<div class="button-group">
  <button type="button" class="btn btn-secondary" id="clearFormBtn">Clear Form</button>
  <button type="submit" class="btn btn-primary" id="submitBtn">
    Confirm Appointment
    <span class="loading-spinner hidden" id="submitSpinner"></span>
  </button>
</div>

    </form>
  </div>

  <div id="loadingOverlay" class="loading-overlay" aria-hidden="true">
    <div class="loading-content">
      <div class="spinner" aria-hidden="true"></div>
      <p id="overlayMessage">Processing your request...</p>
    </div>
  </div>

<script>
/* ==============================================================
   Still Waters â€“ Physician Scheduler (Two Flows)
   MODIFIED: Integrates /FindConsecutiveSlots for Guardian Flow
   MODIFIED: Hides Guardian Slot button until prerequisites are met
   ============================================================== */

var CONFIG = {
  // This endpoint is for the Individual (Self) Flow
  GET_SLOTS_URL: 'https://sw-function-b6c4h9cnexhbh4g3.canadacentral-01.azurewebsites.net/api/Calender',
  
  // NEW: This endpoint is for the multi-person Guardian Flow
  GET_CONSECUTIVE_SLOTS_URL: 'https://sw-function-b6c4h9cnexhbh4g3.canadacentral-01.azurewebsites.net/api/FindConsecutiveSlots',

  // This endpoint is used by both flows
  BOOK_APPOINTMENT_URL: 'https://sw-function-b6c4h9cnexhbh4g3.canadacentral-01.azurewebsites.net/api/CreateEvent',
  
  // Add your function keys here if required
  GET_SLOTS_KEY: '',
  BOOK_APPOINTMENT_KEY: '',
  
  TIMEZONE: 'Central Standard Time', // This MUST match your backend's WORK_TZ_WINDOWS
  CLINIC_NAME: 'Still Waters Professional Counseling â€“ Clinic',
  CLINIC_ADDRESS: '3711 Executive Center Dr. Augusta, GA 30907 '
};

/* ------------------------- State -------------------------- */
var slotsCache = null; // Cache for the Individual (Self) flow only
var selectedSlot = { 
    self: null,      // Stores { y, m, d, start, durationMin, stepMin }
    guardian: null   // Stores { block_start_iso, block_end_iso, timeZone, friendlyText }
};
var visitPlan = {
  self:     { type: null, durationMin: 30, stepMin: 15 },
  guardian: { type: null, durationMin: 30, stepMin: 15 }
};
var updateFlowVisibility;
var updateGuardianSlotButtonVisibility; // NEW: For showing/hiding slot button

/* ------------------------- Utilities -------------------------- */
function withKey(url, key) {
  if (!key) return url;
  try { var u = new URL(url); u.searchParams.set('code', key); return u.toString(); }
  catch { return url + (url.includes('?') ? '&' : '?') + 'code=' + encodeURIComponent(key); }
}
function p2(n){ return (n<10?'0':'')+n; }
function generateUUID(){ return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c==='x'?r:(r&0x3)|0x8;return v.toString(16).toUpperCase();});}
function convertTo24Hour(s){ var t=s.trim().split(' '), hm=t[0].split(':'), h=+hm[0], m=+hm[1], p=t[1]; if(p==='PM'&&h!==12)h+=12; if(p==='AM'&&h===12)h=0; return {hours:h, minutes:m}; }
function hmToMinutes(h,m){ return h*60+m; }
function minutesToHM(total){ return {hour: Math.floor(total/60), minute: total%60}; }
function addMinutesToHM(h, m, d){ var total=h*60+m+d; return {hour:Math.floor(total/60), minute:total%60}; }
function t12fmt(h, m){ var ap=h>=12?'PM':'AM', hh=h%12===0?12:(h%12); return hh+':'+p2(m)+' '+ap; }
function ymdhms(y,m,d,h,mi){ return y+'-'+p2(m)+'-'+p2(d)+'T'+p2(h)+':'+p2(mi)+':00'; }
function localDow(y,m,d){ return ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][new Date(y,m-1,d).getDay()]; }
function getQueryParam(name){ var m=new RegExp('[?&]'+name+'=([^&#]*)').exec(window.location.search); return m?decodeURIComponent(m[1].replace(/\+/g,'%20')):null; }
function referralAddressText(){ return getQueryParam('address') || CONFIG.CLINIC_ADDRESS || ''; }
function calcAgeFromDOBStr(dobStr){ var d=new Date(dobStr); if(isNaN(d))return null; var t=new Date(); var a=t.getFullYear()-d.getFullYear(); var m=t.getMonth()-d.getMonth(); if(m<0||(m===0&&t.getDate()<d.getDate()))a--; return a; }

/* ------------------------- NEW: Prerequisite Check (Guardian) -------------------------- */
function checkGuardianPrerequisites() {
    // This is a "silent" check, no errors shown
    const gf = (document.getElementById('guardFirstName')?.value || '').trim();
    const gl = (document.getElementById('guardLastName')?.value || '').trim();
    const gp = (document.getElementById('guardPhone')?.value || '').trim();
    const loc = getCheckedLocation('guardian'); // {ok: true/false}
    const visitType = document.querySelector('input[name="firstTimeGuardian"]:checked');
    
    const people = collectIndividuals();
    if (people.length === 0) return false;
    
    // Check that all added individuals are complete
    const allIndividualsComplete = people.every(p => p.first && p.last && p.dob);
    if (!allIndividualsComplete) return false;

    // All checks passed
    return gf && gl && gp.replace(/\D/g, '').length >= 7 && loc.ok && visitType;
}

/* ------------------------- Slot parsing (for Self flow) -------------------------- */
function parseSlotString(slotStr){
  var parts = slotStr.split(', ');
  var datePart = parts[0], timePart = parts[1];
  var [dayStr, monStr, yearStr] = datePart.split(' ');
  var day = parseInt(dayStr,10), year = parseInt(yearStr,10);
  var monthMap = {Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12};
  var monthNum = monthMap[monStr];
  var [startStr, endStr] = timePart.split(' - ');
  var start24 = convertTo24Hour(startStr), end24 = convertTo24Hour(endStr);
  return { y:year, m:monthNum, d:day, dateStr:datePart, startMin:hmToMinutes(start24.hours,start24.minutes), endMin:hmToMinutes(end24.hours,end24.minutes) };
}
function groupByDate(slots){
  var map = {};
  slots.forEach(function(s){
    var key = s.y+'-'+p2(s.m)+'-'+p2(s.d);
    if(!map[key]) map[key] = { y:s.y, m:s.m, d:s.d, dateStr:s.dateStr, windows:[] };
    map[key].windows.push({ startMin:s.startMin, endMin:s.endMin });
  });
  return map;
}

/* ------------------------- Visit type per-flow -------------------------- */
function applyVisitType(flow){
  var sel = document.querySelector('input[name="'+(flow==='self'?'firstTimeSelf':'firstTimeGuardian')+'"]:checked');
  visitPlan[flow].type = sel ? (sel.value==='yes'?'first':'followup') : null;
  // This duration is used as "duration per person" in the Guardian flow
  if (visitPlan[flow].type==='first'){ visitPlan[flow].durationMin=60; visitPlan[flow].stepMin=30; }
  else { visitPlan[flow].durationMin=30; visitPlan[flow].stepMin=15; }
}

/* ------------------------- UI helpers -------------------------- */
function showErrorAndScroll(msg){
  showError(msg);
  var el=document.getElementById('errorMessage');
  if (el) el.scrollIntoView({ behavior:'smooth', block:'center' });
}
function showSuccess(){ hideMessages(); var el=document.getElementById('successMessage'); if(el){ el.style.display='block'; setTimeout(function(){ el.style.display='none'; }, 5000);} }
function showError(msg){ hideMessages(); var el=document.getElementById('errorMessage'); if(el){ el.textContent=msg||'Something went wrong.'; el.style.display='block'; setTimeout(function(){ el.style.display='none'; }, 6000);} }
function hideMessages(){ var s=document.getElementById('successMessage'), e=document.getElementById('errorMessage'); if(s)s.style.display='none'; if(e)e.style.display='none'; }
function overlay(on, text){ var ov=document.getElementById('loadingOverlay'); var msg=document.getElementById('overlayMessage'); if(!ov)return; if(typeof text==='string'&&msg) msg.textContent=text; ov.classList.toggle('active', !!on); }

/* ------------------------- Render slots (for Self flow) -------------------------- */
function displaySlotsForFlow(flow, slots){
  const containerId = (flow==='self') ? 'timeSlotsSelf' : 'timeSlotsGuardian';
  const container = document.getElementById(containerId);
  if (!container) return;
  container.innerHTML = '';
  selectedSlot[flow] = null;

  applyVisitType(flow);
  if (!visitPlan[flow].type){ container.innerHTML = '<p>Please choose if this is your first visit or a follow-up.</p>'; return; }
  if (!slots || !slots.length){ container.innerHTML = '<p>No available slots returned by the server. Please check back later.</p>'; return; }

  const parsed = (typeof slots[0] === 'string' || !('startMin' in slots[0])) ? slots.map(parseSlotString) : slots.slice();
  const byDate = groupByDate(parsed);
  const keys = Object.keys(byDate).sort();
  if (!keys.length){ container.innerHTML = '<p>No availability found.</p>'; return; }

  keys.forEach(function(key){
    const dayData = byDate[key];

    const card = document.createElement('div');
    card.className = 'time-slot';

    const header = document.createElement('div');
    header.className = 'date';
    header.textContent = localDow(dayData.y, dayData.m, dayData.d)+' '+dayData.dateStr;

    const grid = document.createElement('div');
    grid.className = 'slot-grid';

    const emitted = new Set();
    const need = visitPlan[flow].durationMin;
    const step = visitPlan[flow].stepMin;

    dayData.windows.forEach(function(w){
      for (let m=w.startMin; m+need<=w.endMin; m+=step){
        if (emitted.has(m)) continue;
        emitted.add(m);

        const startHM = minutesToHM(m);
        const chip = document.createElement('button');
        chip.type = 'button';
        chip.className = 'slot-chip';
        chip.textContent = t12fmt(startHM.hour, startHM.minute);

        chip.addEventListener('click', (function(mm, day){
          return function(){
            container.querySelectorAll('.slot-chip.selected').forEach(function(el){ el.classList.remove('selected'); });
            this.classList.add('selected');
            selectedSlot[flow] = {
              y: day.y, m: day.m, d: day.d,
              start: minutesToHM(mm),
              durationMin: visitPlan[flow].durationMin,
              stepMin: visitPlan[flow].stepMin
            };
          };
        })(m, dayData));

        chip.addEventListener('keydown', function(ev){
          if (ev.key==='Enter' || ev.key===' '){ ev.preventDefault(); chip.click(); }
        });

        grid.appendChild(chip);
      }
    });

    if (!grid.children.length){
      const emptyMsg = document.createElement('div');
      emptyMsg.style.color='var(--muted)';
      emptyMsg.textContent = (visitPlan[flow].type==='first') ? 'No 60-minute starts (30-min steps) fit today.' : 'No 30-minute starts (15-min steps) fit today.';
      grid.appendChild(emptyMsg);
    }

    card.appendChild(header);
    card.appendChild(grid);
    container.appendChild(card);
  });
}

/* ------------------------- NEW: Render Consecutive slots (for Guardian flow) -------------------------- */
function displayConsecutiveSlots(flow, data) {
    const containerId = (flow === 'self') ? 'timeSlotsSelf' : 'timeSlotsGuardian';
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '';
    selectedSlot[flow] = null; // Reset selection

    const groups = data.available_groups;
    if (!groups || groups.length === 0) {
        const totalMins = data.inputs.total_minutes_needed;
        const numPeople = data.inputs.individuals;
        container.innerHTML = `<p>No available slots found for ${numPeople} people (${totalMins} minutes). Please try a different day or call the office.</p>`;
        return;
    }

    const timeZone = data.work_tz_iana; // Get timezone from API response

    // Group by date for display
    const byDate = {};
    groups.forEach(function(g) {
        const key = g.display_date; // "Monday, 03 Nov 2025"
        if (!byDate[key]) byDate[key] = [];
        byDate[key].push(g);
    });

    // Sort keys by actual date
    const keys = Object.keys(byDate).sort(function(a, b) {
        try {
            return new Date(a.split(', ')[1]) - new Date(b.split(', ')[1]);
        } catch (e) {
            return a.localeCompare(b); // Fallback
        }
    });

    keys.forEach(function(key) {
        const dayData = byDate[key];

        const card = document.createElement('div');
        card.className = 'time-slot';

        const header = document.createElement('div');
        header.className = 'date';
        header.textContent = key; // Use the display_date

        const grid = document.createElement('div');
        grid.className = 'slot-grid';

        dayData.forEach(function(group) {
            const chip = document.createElement('button');
            chip.type = 'button';
            chip.className = 'slot-chip';
            chip.textContent = group.display_time_range; // "09:00 AM - 11:00 AM"

            chip.addEventListener('click', function() {
                // Unselect any previously selected chip
                container.querySelectorAll('.slot-chip.selected').forEach(function(el) { el.classList.remove('selected'); });
                this.classList.add('selected');
                
                // NEW: Store the block data required for submission
                selectedSlot[flow] = {
                    block_start_iso: group.block_start_iso,
                    block_end_iso: group.block_end_iso,
                    timeZone: timeZone,
                    friendlyText: `${group.display_date}, ${group.display_time_range}`
                };
            });
            
            chip.addEventListener('keydown', function(ev){
                if (ev.key==='Enter' || ev.key===' '){ ev.preventDefault(); chip.click(); }
            });

            grid.appendChild(chip);
        });
        
        card.appendChild(header);
        card.appendChild(grid);
        container.appendChild(card);
    });
}


/* ------------------------- Fetch slots (for Self flow) -------------------------- */
async function ensureSlots(){
  if (slotsCache) return slotsCache;
  overlay(true, 'Loading available timesâ€¦');
  const url = withKey(CONFIG.GET_SLOTS_URL, CONFIG.GET_SLOTS_KEY);
  try{
    const resp = await fetch(url, { method:'GET', headers:{'Accept':'application/json'} });
    const text = await resp.text();
    if (!resp.ok) throw new Error('Failed to load slots ('+resp.status+')');
    const data = text ? JSON.parse(text) : {};
    const list = Array.isArray(data) ? data
            : (Array.isArray(data.free_slots) ? data.free_slots
            : (Array.isArray(data.freeSlots) ? data.freeSlots
            : (Array.isArray(data.slots) ? data.slots : [])));
    slotsCache = list.map(parseSlotString);
    return slotsCache;
  }catch(e){ console.error(e); showErrorAndScroll('Failed to load available appointment times. Please try again.'); return []; }
  finally{ overlay(false); }
}

/* ------------------------- Household helpers -------------------------- */
function addIndividualCard(){
  const list = document.getElementById('individualsList'); if (!list) return;
  const div = document.createElement('div');
  div.className = 'person-card';
  div.innerHTML = `
    <div class="person-header">
      <span class="person-title">Individual</span>
      <button type="button" class="btn-remove" aria-label="Remove individual">Remove</button>
    </div>
    <div class="form-row">
      <div class="form-group"><label>First Name <span class="required">*</span></label><input type="text" /></div>
      <div class="form-group"><label>Last Name <span class="required">*</span></label><input type="text" /></div>
    </div>
    <div class="form-group"><label>BirthDate <span class="required">*</span></label><input type="date" /></div>
  `;
  
  // MODIFIED: Call visibility check when "Remove" is clicked
  div.querySelector('.btn-remove').addEventListener('click', function(){ 
      div.remove();
      if (typeof updateGuardianSlotButtonVisibility === 'function') {
          updateGuardianSlotButtonVisibility();
      }
  });
  
  list.appendChild(div);
}
function collectIndividuals(){
  return Array.from(document.querySelectorAll('#individualsList .person-card')).map(function(row){
    const inputs = row.querySelectorAll('input');
    const first=(inputs[0]?.value||'').trim();
    const last =(inputs[1]?.value||'').trim();
    const dob  =(inputs[2]?.value||'').trim();
    const age = calcAgeFromDOBStr(dob);
    return { first:first, last:last, dob:dob, age:age, under18:(age!==null?age<18:null) };
  });
}

/* ------------------------- Validation -------------------------- */
function getCheckedLocation(flow){
  const a = document.getElementById(flow==='self'?'selfLocAugusta':'guardLocAugusta');
  const m = document.getElementById(flow==='self'?'selfLocMacon':'guardLocMacon');
  const picked = []; if(a&&a.checked)picked.push(a.value); if(m&&m.checked)picked.push(m.value);
  if (!picked.length) return { ok:false, msg:'Please select a preferred location.' };
  if (picked.length>1) return { ok:false, msg:'Please select only one location.' };
  return { ok:true, value:picked[0] };
}
function validateSelfFlow(){
  if (!document.getElementById('selfConfirm18')?.checked){ showErrorAndScroll('Please confirm you are an individual 18+.'); return false; }
  const first=(document.getElementById('selfFirstName')?.value||'').trim();
  const last =(document.getElementById('selfLastName')?.value||'').trim();
  const email=(document.getElementById('selfEmail')?.value||'').trim();
  const phone=(document.getElementById('selfPhone')?.value||'').trim();
  const dob  =(document.getElementById('selfDob')?.value||'').trim();
  if(!first||!last){ showErrorAndScroll('Please enter your first and last name.'); return false; }
  if(email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ showErrorAndScroll('Please enter a valid email or leave it blank.'); return false; }
  if(phone.replace(/\D/g,'').length<7){ showErrorAndScroll('Please enter a valid phone number.'); return false; }
  const age=calcAgeFromDOBStr(dob); if(age===null||age<18){ showErrorAndScroll('This flow is for individuals 18+.'); return false; }
  applyVisitType('self'); if(!visitPlan.self.type){ showErrorAndScroll('Please select First-Time or Follow-Up.'); return false; }
  if(!selectedSlot.self){ showErrorAndScroll('Please choose an available time.'); return false; } // Checks old slot format
  const loc=getCheckedLocation('self'); if(!loc.ok){ showErrorAndScroll(loc.msg); return false; }
  if(!document.getElementById('selfConsent')?.checked){ showErrorAndScroll('Please consent to reminders.'); return false; }
  if(!document.getElementById('selfEmergency')?.checked){ showErrorAndScroll('Please confirm you are not experiencing an emergency.'); return false; }
  return true;
}
function validateGuardianFlow(){
  if (!document.getElementById('guardianConfirm18')?.checked){ showErrorAndScroll('Please confirm you are a parent/guardian 18+.'); return false; }
  const gf=(document.getElementById('guardFirstName')?.value||'').trim();
  const gl=(document.getElementById('guardLastName')?.value||'').trim();
  const ge=(document.getElementById('guardEmail')?.value||'').trim();
  const gp=(document.getElementById('guardPhone')?.value||'').trim();
  if(!gf||!gl){ showErrorAndScroll('Please enter parent/guardian name.'); return false; }
  if(ge && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(ge)){ showErrorAndScroll('Please enter a valid parent/guardian email or leave it blank.'); return false; }
  if(gp.replace(/\D/g,'').length<7){ showErrorAndScroll('Please enter a valid parent/guardian phone number.'); return false; }
  const people = collectIndividuals();
  if(people.length===0){ showErrorAndScroll('Please add at least one individual.'); return false; }
  for (let i=0;i<people.length;i++){ if(!people[i].first||!people[i].last||!people[i].dob){ showErrorAndScroll('Please complete each individualâ€™s first name, last name, and DOB.'); return false; } }
  applyVisitType('guardian'); if(!visitPlan.guardian.type){ showErrorAndScroll('Please select First-Time or Follow-Up.'); return false; }
  if(!selectedSlot.guardian || !selectedSlot.guardian.block_start_iso){ showErrorAndScroll('Please choose an available time.'); return false; } // Checks NEW slot format
  const loc=getCheckedLocation('guardian'); if(!loc.ok){ showErrorAndScroll(loc.msg); return false; }
  if(!document.getElementById('guardConsent')?.checked){ showErrorAndScroll('Please consent to reminders.'); return false; }
  if(!document.getElementById('guardEmergency')?.checked){ showErrorAndScroll('Please confirm you are not experiencing an emergency.'); return false; }
  return true;
}

/* ------------------------- Confirmation -------------------------- */
function friendlyStartFromSelected(flow){
  const s=selectedSlot[flow].start, y=selectedSlot[flow].y, m=selectedSlot[flow].m, d=selectedSlot[flow].d;
  const mons=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return d+' '+mons[m-1]+' '+y+', '+t12fmt(s.hour, s.minute);
}
function showConfirmation(opts){
  var card = document.getElementById('confirmationCard'); if (!card) return;

  var confWhen = document.getElementById('confWhen');
  var confLocation = document.getElementById('confLocation');
  var confNote = document.getElementById('confNote');
  var outlookLink = document.getElementById('confOutlookLink');

  if (confWhen) confWhen.textContent = opts.whenText || 'â€”';
  if (confLocation) confLocation.textContent = opts.locationText || referralAddressText();
  if (confNote) confNote.textContent = 'Please check in at the front desk when you arrive.';
  if (outlookLink){ outlookLink.removeAttribute('href'); outlookLink.style.display = 'none'; }

  var actions = card.querySelector('.confirm-actions');
  if (actions){
    var existing = document.getElementById('bookAnotherBtn');
    if (!existing){
      var btn = document.createElement('button');
      btn.type = 'button';
      btn.id = 'bookAnotherBtn';
      btn.className = 'btn btn-primary';
      btn.textContent = 'Book another appointment';
      btn.addEventListener('click', function(){
        var fg = document.querySelector('.flow-grid');
        var bg = document.querySelector('.button-group');
        if (fg) fg.style.display = '';
        if (bg) bg.style.display = '';

        clearAll(false);
        
        if (typeof updateFlowVisibility === 'function') {
            updateFlowVisibility();
        }
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
        (document.getElementById('selfConfirm18') || document.getElementById('guardianConfirm18'))?.focus?.();
      });
      actions.prepend(btn);
    } else {
      existing.style.display = 'inline-flex';
    }
  }

  card.classList.add('visible');
  card.scrollIntoView({ behavior:'smooth', block:'center' });
}

/* ------------------------- Submit -> Create event -------------------------- */
async function submitSelf(){
  const first=(document.getElementById('selfFirstName')?.value||'').trim();
  const last =(document.getElementById('selfLastName')?.value||'').trim();
  const email=(document.getElementById('selfEmail')?.value||'').trim();
  const phone=(document.getElementById('selfPhone')?.value||'').trim();
  const dob  =(document.getElementById('selfDob')?.value||'').trim();
  const loc  = getCheckedLocation('self').value;

  try{ localStorage.setItem('sw_client_name', first+' '+last); localStorage.setItem('sw_client_phone', phone); }catch{}

  applyVisitType('self');
  // Read from the 'self' slot structure
  const st=selectedSlot.self.start, dur=visitPlan.self.durationMin;
  const endHM = addMinutesToHM(st.hour, st.minute, dur);
  const startDT = ymdhms(selectedSlot.self.y, selectedSlot.self.m, selectedSlot.self.d, st.hour, st.minute);
  const endDT   = ymdhms(selectedSlot.self.y, selectedSlot.self.m, selectedSlot.self.d, endHM.hour, endHM.minute);
  const friendlyWhen = friendlyStartFromSelected('self');

  const subject = 'Physician visit â€“ ' + (visitPlan.self.type==='first' ? 'First-Time (60m)' : 'Follow-Up (30m)');
  const body = [
    'In-office physician visit for '+first+' '+last+'.',
    'When: '+friendlyWhen+' ('+CONFIG.TIMEZONE+')',
    'Where: '+loc,
    'Check-in: Please check in at the front desk when you arrive.',
    'Contact: '+phone,
    '',
    'Youâ€™ll receive reminders 48h and 24h before your appointment.'
  ].join('\n');

  const payload = {
    subject, body,
    start: { dateTime:startDT, timeZone: CONFIG.TIMEZONE },
    end:   { dateTime:endDT,   timeZone: CONFIG.TIMEZONE },
    expectedDate: selectedSlot.self.y+'-'+p2(selectedSlot.self.m)+'-'+p2(selectedSlot.self.d),
    location: { displayName: 'In-Office â€” '+loc },
    attendees: [],
    allowNewTimeProposals: true,
    transactionId: generateUUID(),
    visitType: visitPlan.self.type,
    dob, over18:'yes', guardian:null, household:null,
    // Send formKind and calendarSite for backend routing
    formKind: 'physician',
    calendarSite: loc.toLowerCase().includes('augusta') ? 'Augusta' : 'Macon'
  };

  if (email) {
      payload.attendees.push({ address: email, name: first+' '+last, type:'required' });
  }

  const resp = await fetch(withKey(CONFIG.BOOK_APPOINTMENT_URL, CONFIG.BOOK_APPOINTMENT_KEY), {
    method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'}, body: JSON.stringify(payload)
  });
  if(!resp.ok){ let t=''; try{ t=await resp.text(); }catch{} throw new Error('Failed to book ('+resp.status+') '+t); }
  const result = await resp.json();
  showSuccess();
  showConfirmation({ whenText: friendlyWhen, locationText: loc, webLink: result?.webLink||null });
  
  document.querySelector('.flow-grid').style.display = 'none';
  document.querySelector('.button-group').style.display = 'none';
  clearAll(true);
}

// MODIFIED: This function now uses the new consecutive slot format
async function submitGuardian(){
  const gf=(document.getElementById('guardFirstName')?.value||'').trim();
  const gl=(document.getElementById('guardLastName')?.value||'').trim();
  const ge=(document.getElementById('guardEmail')?.value||'').trim();
  const gp=(document.getElementById('guardPhone')?.value||'').trim();
  const loc = getCheckedLocation('guardian').value;

  const people = collectIndividuals();
  applyVisitType('guardian'); // Still used for visitType and to get base duration
  
  // MODIFIED: Read block start/end directly from the new slot object
  if (!selectedSlot.guardian || !selectedSlot.guardian.block_start_iso) {
      showErrorAndScroll('Please select an available time slot.');
      return;
  }
  
  const startISO = selectedSlot.guardian.block_start_iso;
  const endISO = selectedSlot.guardian.block_end_iso;
  const timeZone = selectedSlot.guardian.timeZone;
  const friendlyWhen = selectedSlot.guardian.friendlyText;
  
  // Calculate total duration from the selected block
  const dur = (new Date(endISO) - new Date(startISO)) / (1000 * 60);

  const expectedDate = startISO.substring(0, 10); // "2025-11-05"

  const subject = 'Physician visit â€“ ' + (visitPlan.guardian.type==='first' ? 'First-Time' : 'Follow-Up') + ` (${people.length} ${people.length > 1 ? 'people' : 'person'})`;
  const body = [
    'Household physician visit booked by '+gf+' '+gl+'.',
    'When: '+ friendlyWhen + ` (${timeZone})`, // Use friendly text
    'Total Duration: ' + dur + ' minutes',
    'Where: '+loc,
    'Check-in: Please check in at the front desk when you arrive.',
    'Contact: '+gp,
    'Individuals: '+people.map(function(p){ return p.first+' '+p.last+' [DOB: '+p.dob+(p.under18===null?'':', '+(p.under18?'Under 18':'18+'))+']'; }).join('; '),
    '',
    'Youâ€™ll receive reminders 48h and 24h before the appointment.'
  ].join('\n');

  const household = {
    hasSiblings: true,
    householdBlockMinutes: dur, // Use the new total duration
    under18Guardian: { sameAsMain: true, details: { name: gf+' '+gl, phone: gp, email: ge } },
    siblings: people.map(function(p){ return { name:p.first+' '+p.last, dob:p.dob, under18:p.under18, needsAssessment:true, guardianSame:true, guardian:{ name:gf+' '+gl, phone:gp, email:ge } }; })
  };
  
  // MODIFIED: Build payload with new start/end format
  const payload = {
    subject, body,
    start: { dateTime: startISO.substring(0, 19), timeZone: timeZone }, // "2025-11-05T09:00:00"
    end:   { dateTime: endISO.substring(0, 19),   timeZone: timeZone }, // "2025-11-05T12:00:00"
    expectedDate: expectedDate,
    location: { displayName: 'In-Office â€” '+loc },
    attendees: [],
    allowNewTimeProposals: true,
    transactionId: generateUUID(),
    visitType: visitPlan.guardian.type,
    over18:'yes',
    guardian: { name: gf+' '+gl, phone: gp, email: ge },
    household,
    // Send formKind and calendarSite for backend routing
    formKind: 'physician',
    calendarSite: loc.toLowerCase().includes('augusta') ? 'Augusta' : 'Macon'
  };

  if (ge) {
      payload.attendees.push({ address: ge, name: gf+' '+gl, type:'required' });
  }

  const resp = await fetch(withKey(CONFIG.BOOK_APPOINTMENT_URL, CONFIG.BOOK_APPOINTMENT_KEY), {
    method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'}, body: JSON.stringify(payload)
  });
  if(!resp.ok){ let t=''; try{ t=await resp.text(); }catch{} throw new Error('Failed to book ('+resp.status+') '+t); }
  const result = await resp.json();
  showSuccess();
  // MODIFIED: Use friendlyWhen text for confirmation
  showConfirmation({ whenText: friendlyWhen, locationText: loc, webLink: result?.webLink||null });
  
  document.querySelector('.flow-grid').style.display = 'none';
  document.querySelector('.button-group').style.display = 'none';
  
  clearAll(true);
}


/* ------------------------- Submit handler -------------------------- */
async function handleSubmit(e){
  e.preventDefault();
  hideMessages();
  const selfC = document.getElementById('selfConfirm18')?.checked || false;
  const guardC = document.getElementById('guardianConfirm18')?.checked || false;
  if (!selfC && !guardC){ showErrorAndScroll('Please choose a flow: Individual (18+) or Parent/Guardian (18+).'); return; }
  if (selfC && guardC){ showErrorAndScroll('Please use one flow at a time. Uncheck one of the confirmations.'); return; }

  const btn=document.getElementById('submitBtn');
  const spin=document.getElementById('submitSpinner');
  if(btn) btn.disabled=true; if(spin) spin.classList?.remove('hidden');
  overlay(true, 'Submitting your bookingâ€¦');

  try{
    if (selfC){ if (!validateSelfFlow()) return; await submitSelf(); }
    else { if (!validateGuardianFlow()) return; await submitGuardian(); }
  }catch(err){ console.error(err); showErrorAndScroll('There was an error booking your appointment. Please try again or call the office.'); }
  finally{ if(btn) btn.disabled=false; if(spin) spin.classList?.add('hidden'); overlay(false); }
}

/* ------------------------- Misc -------------------------- */
function formatPhoneInput(el){
  if (!el) return;
  el.addEventListener('input', function(e){
    var v=e.target.value.replace(/\D/g,'').slice(0,10);
    if(v.length>6) e.target.value=v.slice(0,3)+'-'+v.slice(3,6)+'-'+v.slice(6);
    else if(v.length>3) e.target.value=v.slice(0,3)+'-'+v.slice(3);
    else e.target.value=v;
  });
}

/* Clear form; keepConfirmation=true keeps the confirmation card visible */
function clearAll(keepConfirmation){
  document.getElementById('physForm')?.reset();
  selectedSlot.self=null; selectedSlot.guardian=null;
  visitPlan.self={type:null,durationMin:30,stepMin:15,stepMin:15};
  visitPlan.guardian={type:null,durationMin:30,stepMin:15};
  const tsS=document.getElementById('timeSlotsSelf'); if(tsS) tsS.innerHTML='';
  const tsG=document.getElementById('timeSlotsGuardian'); if(tsG) tsG.innerHTML='';
  hideMessages();
  const card=document.getElementById('confirmationCard');
  if(card && !keepConfirmation) card.classList.remove('visible');

  const list=document.getElementById('individualsList');
  if(list){
    list.innerHTML='';
    const seed=document.createElement('div');
    seed.className='person-card';
    seed.innerHTML=`
      <div class="person-header"><span class="person-title">Individual</span></div>
      <div class="form-row">
        <div class="form-group"><label>First Name <span class="required">*</span></label><input type="text" /></div>
        <div class="form-group"><label>Last Name <span class="required">*</span></label><input type="text" /></div>
      </div>
      <div class="form-group"><label>BirthDate <span class="required">*</span></label><input type="date" /></div>
    `;
    list.appendChild(seed);
  }
}
function makeCheckboxesMutuallyExclusive(aId,bId){
  const a=document.getElementById(aId), b=document.getElementById(bId);
  if(a) a.addEventListener('change', function(){ if(a.checked&&b) b.checked=false; });
  if(b) b.addEventListener('change', function(){ if(b.checked&&a) a.checked=false; });
}

/* ------------------------- Wire-up -------------------------- */
document.addEventListener('DOMContentLoaded', function(){
  formatPhoneInput(document.getElementById('selfPhone'));
  formatPhoneInput(document.getElementById('guardPhone'));

  const selfC = document.getElementById('selfConfirm18');
  const guardC = document.getElementById('guardianConfirm18');
  const flowSelfEl = document.getElementById('flowSelf');
  const flowGuardianEl = document.getElementById('flowGuardian');
  
  // NEW: Get the guardian slot button
  const loadSlotsGuardianBtn = document.getElementById('loadSlotsGuardianBtn');

  // NEW: Define the handler function and assign to global var
  updateGuardianSlotButtonVisibility = function() {
      if (!loadSlotsGuardianBtn) return;
      
      if (checkGuardianPrerequisites()) {
          loadSlotsGuardianBtn.style.display = 'inline-flex';
      } else {
          loadSlotsGuardianBtn.style.display = 'none';
          // Also clear slots if prerequisites become invalid
          const tsG=document.getElementById('timeSlotsGuardian'); 
          if(tsG) tsG.innerHTML='';
          selectedSlot.guardian = null;
      }
  }
  
  updateFlowVisibility = function() {
      const selfChecked = selfC.checked;
      const guardChecked = guardC.checked;
      const grid = document.querySelector('.flow-grid');

      if (selfChecked) {
          flowSelfEl.classList.add('flow-active');
          flowGuardianEl.classList.remove('flow-active');
          flowGuardianEl.style.display = 'none';
          flowSelfEl.style.display = 'block';
          if (grid) {
              grid.style.display = 'flex';
              grid.style.justifyContent = 'center';
          }
      } else if (guardChecked) {
          flowGuardianEl.classList.add('flow-active');
          flowSelfEl.classList.remove('flow-active');
          flowSelfEl.style.display = 'none';
          flowGuardianEl.style.display = 'block';
          if (grid) {
              grid.style.display = 'flex';
              grid.style.justifyContent = 'center';
          }
      } else {
          flowSelfEl.classList.remove('flow-active');
          flowGuardianEl.classList.remove('flow-active');
          flowSelfEl.style.display = 'block';
          flowGuardianEl.style.display = 'block';
          if (grid) {
              grid.style.display = 'grid';
              grid.style.justifyContent = '';
          }
      }
  }

  if (selfC && guardC && flowSelfEl && flowGuardianEl) {
      selfC.addEventListener('change', function() {
          if (selfC.checked) guardC.checked = false;
          updateFlowVisibility();
      });
      guardC.addEventListener('change', function() {
          if (guardC.checked) selfC.checked = false;
          updateFlowVisibility();
      });
      
      // NEW: Add listeners to the guardian flow card to check prerequisites
      flowGuardianEl.addEventListener('change', updateGuardianSlotButtonVisibility);
      flowGuardianEl.addEventListener('keyup', updateGuardianSlotButtonVisibility);
      
      updateFlowVisibility();
  }

  makeCheckboxesMutuallyExclusive('selfLocAugusta','selfLocMacon');
  makeCheckboxesMutuallyExclusive('guardLocAugusta','guardLocMacon');

  document.querySelectorAll('input[name="firstTimeSelf"]').forEach(function(r){
    r.addEventListener('change', function(){ applyVisitType('self'); if(slotsCache) displaySlotsForFlow('self', slotsCache); });
  });
  
  document.querySelectorAll('input[name="firstTimeGuardian"]').forEach(function(r){
    r.addEventListener('change', function(){ 
        applyVisitType('guardian'); 
        // This will also trigger the 'change' listener on flowGuardianEl
        // which will re-run updateGuardianSlotButtonVisibility
    });
  });

  // Load slots for Self flow (Original)
  document.getElementById('loadSlotsSelfBtn')?.addEventListener('click', async function(){
    applyVisitType('self'); if(!visitPlan.self.type){ showErrorAndScroll('Please select whether this is your first visit or a follow-up.'); return; }
    const slots = await ensureSlots(); displaySlotsForFlow('self', slots);
  });
  
  // MODIFIED: This button is already hidden/shown. This just handles the click.
  document.getElementById('loadSlotsGuardianBtn')?.addEventListener('click', async function(){
    // 1. Get duration per person from radio buttons
    applyVisitType('guardian'); 
    // Note: Prerequisites are already met if this button is visible
    // but we can re-check key ones just in case.
    if(!visitPlan.guardian.type){ showErrorAndScroll('Please select "First time" (60 min) or "Follow-up" (30 min) per person.'); return; }
    const slotDurationMinutes = visitPlan.guardian.durationMin;

    // 2. Get number of individuals
    const individuals = collectIndividuals();
    if (individuals.length === 0) { showErrorAndScroll('Please add at least one individual.'); return; }
    const numIndividuals = individuals.length;

    // 3. Get location
    const loc = getCheckedLocation('guardian');
    if (!loc.ok) { showErrorAndScroll(loc.msg); return; }
    const siteKey = loc.value.toLowerCase().includes('augusta') ? 'Augusta' : 'Macon';

    const container = document.getElementById('timeSlotsGuardian');
    if (container) container.innerHTML = `<p>Loading slots for ${numIndividuals} ${numIndividuals > 1 ? 'people' : 'person'} (${numIndividuals * slotDurationMinutes} mins total)...</p>`;
    overlay(true, 'Loading available timesâ€¦');

    // 4. Build URL for new endpoint
    const params = new URLSearchParams({
        individuals: numIndividuals,
        slotDurationMinutes: slotDurationMinutes,
        formKind: 'physician',
        calendarSite: siteKey
    });
    const baseUrl = withKey(CONFIG.GET_CONSECUTIVE_SLOTS_URL, CONFIG.GET_SLOTS_KEY);
    const url = baseUrl + (baseUrl.includes('?') ? '&' : '?') + params.toString();

    try {
        const resp = await fetch(url, { method:'GET', headers:{'Accept':'application/json'} });
        const data = await resp.json();
        if (!resp.ok || data.ok === false) throw new Error(data.details || data.error || 'Failed to load slots');

        // 5. Call NEW display function
        displayConsecutiveSlots('guardian', data);

    } catch(e) { 
        console.error(e); 
        showErrorAndScroll('Failed to load available appointment times. Please try again or call the office.'); 
        if (container) container.innerHTML = '<p style="color: #a94442;">Error loading slots. Please try again.</p>';
    } finally { 
        overlay(false); 
    }
  });


  // Add +Individuals
  // MODIFIED: This now calls the visibility check
  document.getElementById('addIndividualBtn')?.addEventListener('click', function() {
      addIndividualCard();
      updateGuardianSlotButtonVisibility();
  });

  // Submit & Clear
  document.getElementById('physForm')?.addEventListener('submit', handleSubmit);
  document.getElementById('clearFormBtn')?.addEventListener('click', function(){ 
      clearAll(false); 
      if (typeof updateFlowVisibility === 'function') {
          updateFlowVisibility();
      }
      // NEW: Manually hide the guardian button on clear
      if (typeof updateGuardianSlotButtonVisibility === 'function') {
          updateGuardianSlotButtonVisibility();
      }
  });

  // Prefill convenience
  try{
    const nm=getQueryParam('name')||localStorage.getItem('sw_client_name');
    const ph=getQueryParam('phone')||localStorage.getItem('sw_client_phone');
    if(nm){
      const parts=nm.trim().split(' '), f=parts.shift()||'', l=parts.join(' ')||'';
      if(document.getElementById('selfFirstName')) document.getElementById('selfFirstName').value=f;
      if(document.getElementById('selfLastName'))  document.getElementById('selfLastName').value=l;
    }
    if(ph && document.getElementById('selfPhone')) document.getElementById('selfPhone').value=ph;
  }catch{}
});
</script>

</body>

</html>
